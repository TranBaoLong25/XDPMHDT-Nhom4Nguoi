# ✅ Upstream khớp với service name trong docker-compose.yml
upstream user-service {
    server user-service:5000;   # Flask User Service
}

server {
    listen 80;
    server_name localhost;

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    client_max_body_size 50M;

    # ======================================================
    # 1️⃣ ROUTE: API (ĐÃ SỬA)
    # ======================================================
    # Frontend gọi: /user/api/register
    # Backend nhận: /api/register
    location /user/api/ {
        # Dấu / ở cuối proxy_pass rất quan trọng
        # Nó sẽ lấy request "/user/api/register"
        # và gửi đến "http://user-service" + "/api/" + "register"
        proxy_pass http://user-service/api/;

        # Forward các header gốc
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ======================================================
    # 2️⃣ STATIC UPLOADS (ảnh, file)
    # ======================================================
    location /uploads/ {
        alias /usr/share/nginx/html/uploads/;
        expires 1d;
        add_header Cache-Control "public, must-revalidate, proxy-revalidate";
    }

    # ======================================================
    # 3️⃣ FRONTEND SPA (Vue/React/Angular)
    # ======================================================
    # Đây là lý do chúng ta không cần service "frontend" nữa
    location / {
        root /usr/share/nginx/html/frontend; # Đường dẫn này phải khớp với Dockerfile
        index index.html;
        try_files $uri $uri/ /index.html;
    }
}