<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Notification Service - EV Service Center</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 32px;
        }
        h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        h3 {
            color: #555;
            margin: 15px 0 10px 0;
            font-size: 16px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }
        input, select, textarea, button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        button.secondary {
            background: #4caf50;
        }
        button.secondary:hover {
            background: #45a049;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
        .response {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .token-display {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            word-break: break-all;
            font-size: 11px;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stats-card h3 {
            color: white;
            margin: 0 0 10px 0;
        }
        .stats-card .number {
            font-size: 36px;
            font-weight: bold;
        }
        .notification-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 12px;
            margin: 8px 0;
            border-radius: 4px;
        }
        .notification-item.unread {
            background: #e3f2fd;
            border-left-color: #2196f3;
        }
        .notification-item h4 {
            margin: 0 0 5px 0;
            color: #333;
        }
        .notification-item p {
            margin: 5px 0;
            color: #666;
            font-size: 14px;
        }
        .notification-item .meta {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
        }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-right: 5px;
        }
        .badge-high { background: #ffebee; color: #c62828; }
        .badge-urgent { background: #b71c1c; color: white; }
        .badge-medium { background: #fff3e0; color: #e65100; }
        .badge-low { background: #e8f5e9; color: #2e7d32; }
        .btn-group {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .btn-group button {
            width: auto;
            padding: 6px 12px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîî Test Notification Service</h1>

        <!-- Login Section -->
        <div class="card">
            <h2>1. üîë ƒêƒÉng nh·∫≠p (User/Admin)</h2>
            <label>Email:</label>
            <input type="email" id="loginEmail" value="admin2@evservice.com" placeholder="admin2@evservice.com ho·∫∑c user@example.com">
            <label>Password:</label>
            <input type="password" id="loginPassword" value="Admin@123456" placeholder="Password">
            <button onclick="login()">ƒêƒÉng nh·∫≠p</button>
            <div id="loginResponse" class="response"></div>
            <div id="tokenDisplay" class="token-display" style="display:none">
                <strong>Access Token:</strong><br>
                <span id="tokenValue"></span>
            </div>
        </div>

        <!-- Stats -->
        <div class="card">
            <h2>2. üìä Th·ªëng k√™ Notifications</h2>
            <button onclick="getStats()">L·∫•y Th·ªëng k√™</button>
            <div id="statsContainer" class="grid" style="margin-top: 15px;"></div>
        </div>

        <!-- My Notifications -->
        <div class="card">
            <h2>3. üì¨ Notifications c·ªßa t√¥i</h2>
            <div style="display: flex; gap: 10px;">
                <button onclick="getMyNotifications(false)">T·∫•t c·∫£ Notifications</button>
                <button class="secondary" onclick="getMyNotifications(true)">Ch·ªâ Ch∆∞a ƒë·ªçc</button>
            </div>
            <div id="myNotificationsContainer" style="margin-top: 15px;"></div>
        </div>

        <div class="grid">
            <!-- Create Notification (Internal API) -->
            <div class="card">
                <h2>4. ‚ûï T·∫°o Notification (Internal)</h2>
                <p style="color: #f44336; font-size: 12px; margin-bottom: 10px;">
                    ‚ö†Ô∏è API n√†y y√™u c·∫ßu INTERNAL_SERVICE_TOKEN
                </p>
                <label>User ID:</label>
                <input type="number" id="createUserId" value="3" placeholder="3">
                <label>Type:</label>
                <select id="createType">
                    <option value="booking">booking</option>
                    <option value="maintenance">maintenance</option>
                    <option value="payment">payment</option>
                    <option value="system">system</option>
                </select>
                <label>Title:</label>
                <input type="text" id="createTitle" placeholder="Booking ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n">
                <label>Message:</label>
                <textarea id="createMessage" placeholder="L·ªãch h·∫πn c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n..."></textarea>
                <label>Priority:</label>
                <select id="createPriority">
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                    <option value="urgent">Urgent</option>
                </select>
                <button onclick="createNotification()">T·∫°o Notification</button>
                <div id="createResponse" class="response"></div>
            </div>

            <!-- Admin: Get All -->
            <div class="card">
                <h2>5. üëë Admin: T·∫•t c·∫£ Notifications</h2>
                <p style="color: #2196f3; font-size: 12px; margin-bottom: 10px;">
                    ‚ÑπÔ∏è Ch·ªâ Admin m·ªõi c√≥ quy·ªÅn truy c·∫≠p
                </p>
                <button onclick="getAllNotificationsAdmin()">L·∫•y t·∫•t c·∫£ (Admin)</button>
                <div id="adminAllResponse" class="response"></div>
            </div>
        </div>

        <!-- Actions -->
        <div class="card">
            <h2>6. ‚ö° Actions</h2>
            <div class="grid">
                <div>
                    <h3>ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc</h3>
                    <label>Notification ID:</label>
                    <input type="number" id="markReadId" placeholder="1">
                    <button class="secondary" onclick="markAsRead()">ƒê√°nh d·∫•u ƒê√£ ƒë·ªçc</button>
                    <div id="markReadResponse" class="response"></div>
                </div>
                <div>
                    <h3>ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc</h3>
                    <button class="secondary" onclick="markAllAsRead()">ƒê√°nh d·∫•u T·∫•t c·∫£ ƒê√£ ƒë·ªçc</button>
                    <div id="markAllReadResponse" class="response"></div>
                </div>
                <div>
                    <h3>X√≥a Notification</h3>
                    <label>Notification ID:</label>
                    <input type="number" id="deleteId" placeholder="1">
                    <button class="danger" onclick="deleteNotification()">X√≥a Notification</button>
                    <div id="deleteResponse" class="response"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let token = '';
        let userId = null;
        const API_BASE = 'http://localhost';

        function showResponse(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = 'response ' + (isError ? 'error' : 'success');
            element.textContent = JSON.stringify(data, null, 2);
        }

        async function apiCall(endpoint, method = 'GET', body = null, useToken = true, customHeaders = {}) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    ...customHeaders
                }
            };

            if (useToken && token) {
                options.headers['Authorization'] = `Bearer ${token}`;
            }

            if (body) {
                options.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const data = await response.json();
                return { data, ok: response.ok, status: response.status };
            } catch (error) {
                return { data: { error: error.message }, ok: false };
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            const result = await apiCall('/api/login', 'POST', {
                email_username: email,
                password: password
            }, false);

            if (result.ok && result.data.access_token) {
                token = result.data.access_token;
                const payload = JSON.parse(atob(token.split('.')[1]));
                userId = parseInt(payload.sub);

                document.getElementById('tokenDisplay').style.display = 'block';
                document.getElementById('tokenValue').textContent = token;
                document.getElementById('createUserId').value = userId;

                showResponse('loginResponse', {
                    message: 'ƒêƒÉng nh·∫≠p th√†nh c√¥ng!',
                    user_id: userId,
                    role: payload.role
                });
            } else {
                showResponse('loginResponse', result.data, true);
            }
        }

        async function getStats() {
            const result = await apiCall('/api/notifications/stats');

            if (result.ok) {
                const stats = result.data;
                const container = document.getElementById('statsContainer');
                container.innerHTML = `
                    <div class="stats-card">
                        <h3>T·ªïng s·ªë</h3>
                        <div class="number">${stats.total || 0}</div>
                    </div>
                    <div class="stats-card">
                        <h3>Ch∆∞a ƒë·ªçc</h3>
                        <div class="number">${stats.unread || 0}</div>
                    </div>
                    <div class="stats-card">
                        <h3>ƒê√£ ƒë·ªçc</h3>
                        <div class="number">${stats.read || 0}</div>
                    </div>
                `;
            } else {
                document.getElementById('statsContainer').innerHTML =
                    `<p style="color: red;">L·ªói: ${result.data.error || result.data.message}</p>`;
            }
        }

        async function getMyNotifications(unreadOnly = false) {
            const endpoint = `/api/notifications/my-notifications${unreadOnly ? '?unread_only=true' : ''}`;
            const result = await apiCall(endpoint);

            const container = document.getElementById('myNotificationsContainer');

            if (result.ok && Array.isArray(result.data)) {
                if (result.data.length === 0) {
                    container.innerHTML = '<p style="color: #999;">Kh√¥ng c√≥ notification n√†o.</p>';
                    return;
                }

                container.innerHTML = result.data.map(n => {
                    const isUnread = !n.read_at;
                    const priorityClass = `badge-${n.priority}`;

                    return `
                        <div class="notification-item ${isUnread ? 'unread' : ''}">
                            <h4>
                                <span class="badge ${priorityClass}">${n.priority.toUpperCase()}</span>
                                ${n.title}
                            </h4>
                            <p>${n.message}</p>
                            <div class="meta">
                                Type: ${n.notification_type} |
                                Status: ${n.status} |
                                Created: ${new Date(n.created_at).toLocaleString('vi-VN')}
                                ${n.read_at ? `| Read: ${new Date(n.read_at).toLocaleString('vi-VN')}` : ''}
                            </div>
                            <div class="btn-group">
                                ${isUnread ? `<button onclick="markAsReadById(${n.id})">ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc</button>` : ''}
                                <button class="danger" onclick="deleteNotificationById(${n.id})">X√≥a</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = `<p style="color: red;">L·ªói: ${result.data.error || result.data.message}</p>`;
            }
        }

        async function createNotification() {
            const internalToken = prompt('Nh·∫≠p INTERNAL_SERVICE_TOKEN (t·ª´ .env):', 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...');
            if (!internalToken) return;

            const body = {
                user_id: parseInt(document.getElementById('createUserId').value),
                notification_type: document.getElementById('createType').value,
                title: document.getElementById('createTitle').value,
                message: document.getElementById('createMessage').value,
                priority: document.getElementById('createPriority').value,
                channel: 'web'
            };

            const result = await apiCall('/internal/notifications/create', 'POST', body, false, {
                'X-Internal-Token': internalToken
            });

            showResponse('createResponse', result.data, !result.ok);
            if (result.ok) {
                getMyNotifications();
                getStats();
            }
        }

        async function getAllNotificationsAdmin() {
            const result = await apiCall('/api/notifications/admin/all');
            showResponse('adminAllResponse', result.data, !result.ok);
        }

        async function markAsRead() {
            const id = document.getElementById('markReadId').value;
            const result = await apiCall(`/api/notifications/${id}/read`, 'PUT');
            showResponse('markReadResponse', result.data, !result.ok);
            if (result.ok) {
                getMyNotifications();
                getStats();
            }
        }

        async function markAsReadById(id) {
            const result = await apiCall(`/api/notifications/${id}/read`, 'PUT');
            if (result.ok) {
                getMyNotifications();
                getStats();
            } else {
                alert('L·ªói: ' + (result.data.error || result.data.message));
            }
        }

        async function markAllAsRead() {
            const result = await apiCall('/api/notifications/read-all', 'PUT');
            showResponse('markAllReadResponse', result.data, !result.ok);
            if (result.ok) {
                getMyNotifications();
                getStats();
            }
        }

        async function deleteNotification() {
            const id = document.getElementById('deleteId').value;
            if (!confirm(`X√≥a notification ${id}?`)) return;

            const result = await apiCall(`/api/notifications/${id}`, 'DELETE');
            showResponse('deleteResponse', result.data, !result.ok);
            if (result.ok) {
                getMyNotifications();
                getStats();
            }
        }

        async function deleteNotificationById(id) {
            if (!confirm(`X√≥a notification ${id}?`)) return;

            const result = await apiCall(`/api/notifications/${id}`, 'DELETE');
            if (result.ok) {
                getMyNotifications();
                getStats();
            } else {
                alert('L·ªói: ' + (result.data.error || result.data.message));
            }
        }
    </script>
</body>
</html>
